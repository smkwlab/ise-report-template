name: âœ‹ ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨PRï¼ˆãƒžãƒ¼ã‚¸ç¦æ­¢ï¼‰

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - review-branch

jobs:
  check-draft-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Check if branch is draft
        id: check-draft
        run: |
          set -e  # ã‚¨ãƒ©ãƒ¼æ™‚ã«å³åº§ã«åœæ­¢
          
          BRANCH_NAME="${{ github.head_ref }}"
          echo "::debug::Starting branch analysis for ISE report"
          echo "::debug::Branch name: $BRANCH_NAME"
          echo "::debug::Current HEAD: $(git rev-parse HEAD)"
          
          # Git ãƒªãƒã‚¸ãƒˆãƒªçŠ¶æ…‹ç¢ºèª
          if ! git rev-parse --git-dir >/dev/null 2>&1; then
            echo "::error::Git repository not found"
            exit 1
          fi
          
          # final-* ã‚¿ã‚°ãƒã‚§ãƒƒã‚¯ï¼ˆISE reportsç”¨ï¼‰
          echo "::debug::Checking for final-* tags..."
          TAGS_AT_HEAD=""
          if TAGS_AT_HEAD=$(git tag --points-at HEAD 2>/dev/null); then
            echo "::debug::Tags at HEAD: ${TAGS_AT_HEAD:-'none'}"
            
            if echo "$TAGS_AT_HEAD" | grep -q "^final-"; then
              FINAL_TAG=$(echo "$TAGS_AT_HEAD" | grep "^final-" | head -1)
              echo "is_draft=false" >> $GITHUB_OUTPUT
              echo "is_final_submission=true" >> $GITHUB_OUTPUT
              echo "final_tag=$FINAL_TAG" >> $GITHUB_OUTPUT
              echo "âœ… Final submission detected - merge allowed"
              echo "::notice::Final submission tag: $FINAL_TAG"
              exit 0
            fi
          else
            echo "::debug::No tags found at HEAD (this is normal for draft branches)"
          fi
          
          # ãƒ–ãƒ©ãƒ³ãƒåæ¤œè¨¼ï¼ˆç‰¹æ®Šæ–‡å­—å¯¾å¿œï¼‰
          if [[ -z "$BRANCH_NAME" ]]; then
            echo "::error::Branch name is empty"
            exit 1
          fi
          
          # draftç³»ãƒ–ãƒ©ãƒ³ãƒã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯ï¼ˆISE reportsç”¨ï¼‰
          echo "::debug::Checking ISE draft branch patterns..."
          
          # ISEæ·»å‰Šãƒ–ãƒ©ãƒ³ãƒï¼ˆ1st-draft, 2nd-draftç­‰ï¼‰
          if [[ "$BRANCH_NAME" =~ ^[0-9]+(st|nd|rd|th)-draft$ ]]; then
            echo "::debug::Matched ISE draft pattern: $BRANCH_NAME"
            echo "is_draft=true" >> $GITHUB_OUTPUT
            echo "draft_type=ise" >> $GITHUB_OUTPUT
          # åˆæœŸæå‡ºãƒ–ãƒ©ãƒ³ãƒï¼ˆ0th-draftï¼‰
          elif [[ "$BRANCH_NAME" =~ ^0th-draft$ ]]; then
            echo "::debug::Matched initial ISE draft pattern: $BRANCH_NAME"
            echo "is_draft=true" >> $GITHUB_OUTPUT  
            echo "draft_type=initial" >> $GITHUB_OUTPUT
          # é€šå¸¸ãƒ–ãƒ©ãƒ³ãƒ
          else
            echo "::debug::No draft pattern matched - regular branch"
            echo "is_draft=false" >> $GITHUB_OUTPUT
            echo "draft_type=none" >> $GITHUB_OUTPUT
          fi
          
          echo "::debug::ISE branch analysis completed"

      - name: Block draft branch merge
        if: steps.check-draft.outputs.is_draft == 'true'
        run: |
          DRAFT_TYPE="${{ steps.check-draft.outputs.draft_type }}"
          BRANCH_NAME="${{ github.head_ref }}"
          
          echo "::error::âŒ ISEæ·»å‰Šç”¨ãƒ–ãƒ©ãƒ³ãƒã¯ãƒžãƒ¼ã‚¸ç¦æ­¢ã§ã™"
          echo "::error::ðŸ“ ãƒ–ãƒ©ãƒ³ãƒå: $BRANCH_NAME"
          echo "::error::ðŸŽ¯ ã“ã®PRã¯æ•™å“¡ã«ã‚ˆã‚‹æ·»å‰Šãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã§ã™"
          
          # ãƒ–ãƒ©ãƒ³ãƒã‚¿ã‚¤ãƒ—åˆ¥ã®è©³ç´°èª¬æ˜Žï¼ˆISEç”¨ï¼‰
          case "$DRAFT_TYPE" in
            "initial")
              echo "::error::â„¹ï¸  åˆæœŸæå‡ºç”¨ãƒ–ãƒ©ãƒ³ãƒã§ã™ï¼ˆ0th-draftï¼‰"
              echo "::error::ðŸ“‹ ç›®çš„ï¼šåˆå›žã®ãƒ¬ãƒãƒ¼ãƒˆæ§‹æˆãƒ»å†…å®¹ç¢ºèª"
              echo "::error::ðŸŽ¯ æƒ…å ±ç§‘å­¦æ¼”ç¿’ã®åˆå›žæå‡ºç”¨ãƒ‰ãƒ©ãƒ•ãƒˆ"
              ;;
            "ise")
              echo "::error::â„¹ï¸  ISEãƒ¬ãƒãƒ¼ãƒˆæ·»å‰Šç”¨ãƒ–ãƒ©ãƒ³ãƒã§ã™ï¼ˆ1st-draft, 2nd-draftç­‰ï¼‰"
              echo "::error::ðŸ“‹ ç›®çš„ï¼šHTMLãƒ¬ãƒãƒ¼ãƒˆã®æ®µéšŽçš„æ”¹å–„ãƒ»å“è³ªå‘ä¸Š"
              echo "::error::ðŸŽ¯ æƒ…å ±ç§‘å­¦æ¼”ç¿’Iãƒ»IIã®æ·»å‰Šä¾é ¼ç”¨"
              ;;
            *)
              echo "::error::â„¹ï¸  æ·»å‰Šä¾é ¼ç”¨ãƒ–ãƒ©ãƒ³ãƒã§ã™"
              ;;
          esac
          
          echo "::error::ðŸ“ æ­£ã—ã„ISEãƒ¬ãƒãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼š"
          echo "::error::  1ï¸âƒ£ å­¦ç”Ÿï¼šä½œæ¥­ç”¨ãƒ–ãƒ©ãƒ³ãƒã§ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ"
          echo "::error::  2ï¸âƒ£ å­¦ç”Ÿï¼šwww-stã‚µãƒ¼ãƒãƒ¼ã¸ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»PRä½œæˆ"
          echo "::error::  3ï¸âƒ£ æ•™å“¡ï¼šHTMLãƒ¬ãƒãƒ¼ãƒˆãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æä¾›"
          echo "::error::  4ï¸âƒ£ å­¦ç”Ÿï¼šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å¯¾å¿œãƒ»ä¿®æ­£"
          echo "::error::  5ï¸âƒ£ å­¦ç”Ÿï¼šå¯¾å¿œå®Œäº†å¾Œã«PRã‚’ã‚¯ãƒ­ãƒ¼ã‚º"
          echo "::error::  6ï¸âƒ£ å­¦ç”Ÿï¼šæ¬¡ã®ä½œæ¥­ç”¨ãƒ–ãƒ©ãƒ³ãƒã§ç¶™ç¶šä½œæ¥­"
          
          echo ""
          echo "::notice::ðŸ‘¨â€ðŸŽ“ å­¦ç”Ÿã®æ–¹ï¼šãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾å¿œå®Œäº†å¾Œã«PRã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¦ãã ã•ã„"
          echo "::notice::ðŸ‘¨â€ðŸ« æ•™å“¡ã®æ–¹ï¼šHTMLãƒ¬ãƒãƒ¼ãƒˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã¿å®Ÿæ–½ã—ã€ãƒžãƒ¼ã‚¸ã¯è¡Œã‚ãªã„ã§ãã ã•ã„"
          echo "::notice::ðŸ“– è©³ç´°ï¼šREADME.md ã®æƒ…å ±ç§‘å­¦æ¼”ç¿’ãƒ¬ãƒãƒ¼ãƒˆä½œæˆãƒ•ãƒ­ãƒ¼ã‚’ã”ç¢ºèªãã ã•ã„"
          
          echo "::debug::ISE Branch type: $DRAFT_TYPE, Action: Block merge"
          
          # GitHub Summaryã«å­¦ç”Ÿå‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## âœ… æ­£å¸¸å‹•ä½œï¼šãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨PRã§ã™
          
          ã“ã®PRã¯ **æ•™å“¡ã«ã‚ˆã‚‹æ·»å‰Šãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨** ã§ã™ã€‚
          
          **ðŸ“ å­¦ç”Ÿã®æ–¹ã¸**
          - ã“ã®ã€Œå¤±æ•—ã€è¡¨ç¤ºã¯æ­£å¸¸ã§ã™ï¼ˆã‚¨ãƒ©ãƒ¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰
          - æ•™å“¡ã‹ã‚‰ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠå¾…ã¡ãã ã•ã„
          - ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾å¿œå®Œäº†å¾Œã€PRã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¦ãã ã•ã„
          - æ¬¡ã®ä½œæ¥­ã¯æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã§è¡Œã£ã¦ãã ã•ã„
          
          **ðŸŽ¯ ç›®çš„**
          - èª¤ã£ã¦ãƒžãƒ¼ã‚¸ã™ã‚‹ã“ã¨ã‚’é˜²ãå®‰å…¨æ©Ÿèƒ½
          - é©åˆ‡ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œ
          EOF
          
          exit 1

      - name: Success - Non-draft branch
        if: steps.check-draft.outputs.is_draft == 'false'
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          IS_FINAL="${{ steps.check-draft.outputs.is_final_submission }}"
          
          if [[ "$IS_FINAL" == "true" ]]; then
            FINAL_TAG="${{ steps.check-draft.outputs.final_tag }}"
            echo "ðŸŽ“ ISEãƒ¬ãƒãƒ¼ãƒˆæœ€çµ‚æå‡ºãƒ–ãƒ©ãƒ³ãƒã§ã™ - ãƒžãƒ¼ã‚¸è¨±å¯"
            echo "ðŸ“ ãƒ–ãƒ©ãƒ³ãƒå: $BRANCH_NAME"
            echo "ðŸ·ï¸  æœ€çµ‚æå‡ºã‚¿ã‚°: $FINAL_TAG"
            echo "::notice::ISEãƒ¬ãƒãƒ¼ãƒˆæœ€çµ‚æå‡ºãƒ•ãƒ­ãƒ¼ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™"
          else
            echo "âœ… é€šå¸¸ã®ãƒ–ãƒ©ãƒ³ãƒã§ã™ - ãƒžãƒ¼ã‚¸å¯èƒ½"
            echo "ðŸ“ ãƒ–ãƒ©ãƒ³ãƒå: $BRANCH_NAME"
            echo "::notice::é€šå¸¸ã®ãƒ–ãƒ©ãƒ³ãƒã®ãŸã‚ã€ãƒžãƒ¼ã‚¸åˆ¶é™ã¯ã‚ã‚Šã¾ã›ã‚“"
          fi
          
          echo "::debug::ISE branch check passed - merge allowed"